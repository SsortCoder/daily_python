import requests as rq
from datetime import datetime
import json


def compare_currencies(currency1, rate1, currency2, rate2):
    difference = rate1 - rate2
    if difference > 0:
        return f'{currency1} –¥–æ—Ä–æ–∂–µ {currency2} –Ω–∞ {difference:.2f}—Ä—É–±'
    return f"{currency2} –¥–æ—Ä–æ–∂–µ {currency1} –Ω–∞ {abs(difference):.2f} —Ä—É–±"



try:
    url = 'https://www.cbr-xml-daily.ru/daily_json.js'
    responce = rq.get(url)

    print("–°—Ç–∞—Ç—É—Å:", responce.status_code)



    if responce.status_code == 200:
        data = responce.json()

        update_data = update_date = datetime.strptime(data['Date'][:19], "%Y-%m-%dT%H:%M:%S")
        formatted_date = update_date.strftime("%d.%m.%Y %H:%M")

        usd_rate = data['Valute']['USD']['Value']
        usd_name = data['Valute']['USD']['Name']

        eur_rate = data['Valute']['EUR']['Value']
        eur_name = data['Valute']['EUR']['Name']

        try:
            gbp_rate = data['Valute']['GBP']['Value']
            gbp_name = data['Valute']['GBP']['Name']
        except KeyError:
            gbp_rate = 0
            gbp_name = "–§—É–Ω—Ç —Å—Ç–µ—Ä–ª–∏–Ω–≥–æ–≤ (–¥–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã)"


        print(f'\n–ö—É—Ä—Å {usd_name}: {usd_rate:.2f} —Ä—É–±')
        print(f'\n–ö—É—Ä—Å {eur_name}: {eur_rate:.2f} —Ä—É–±')
        print(f'\n–ö—É—Ä—Å {gbp_name}: {gbp_rate:.2f} —Ä—É–±')

        print(f'\n–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {formatted_date}')
    

        data_to_save = {
            'date': formatted_date,
            'rates': {
                'USD': usd_rate,
                'EUR': eur_rate,
                'GBP': gbp_rate
            }
        }
        with open('rates.json', 'w', encoding='utf-8') as f:
            json.dump(data_to_save, f, indent=2, ensure_ascii=False)
            print('\nüíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ rates.json')

        print('\n' + compare_currencies("–î–æ–ª–ª–∞—Ä(–∞)", usd_rate, "–ï–≤—Ä–æ", eur_rate))
        print(compare_currencies("–î–æ–ª–ª–∞—Ä(–∞)", usd_rate, "–§—É–Ω—Ç(–∞)", gbp_rate))
        print('-----------------------')
    else:
            print("–û—à–∏–±–∫–∞! –ö–æ–¥:", responce.status_code)

except Exception as e:
    print("–û—à–∏–±–∫–∞", e)

import matplotlib.pyplot as plt

currencies = ['USD', 'EUR', 'GBP']
rates = [usd_rate, eur_rate, gbp_rate]

plt.figure(figsize=(10, 5))
bars = plt.bar(currencies, rates, color=['#1f77b4', '#ff7f0e', '#2ca02c'])

plt.title('–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç', fontsize=14)
plt.ylabel('–†—É–±–ª–∏', fontsize=12)
plt.grid(axis='y', linestyle='--', alpha=0.7)

for bar in bars:
    height = bar.get_height()
    plt.text(bar.get_x() + bar.get_width()/2., height,
             f'{height:.2f}',
             ha='center', va='bottom')

plt.savefig('currency_rates.png')
print('\nüìä –ì—Ä–∞—Ñ–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∫–∞–∫ currency_rates.png')


plt.show()

